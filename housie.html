<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Housie</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,500,700,400italic|Material+Icons" />
    <link rel = "stylesheet"
    href = "https://fonts.googleapis.com/icon?family=Material+Icons">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script> -->
    <style>
        table, tr>td{
            border: 2px solid indigo;
        }
        .highlight-picked-num{
            color: blue;
            font-size: 2rem;
        }
        .v-dialog__container{
            display: block !important;
        }
        .usedTickets-card{
            min-height: 3rem;
        }
        .usedTickets-inside-card{
            display: inline-grid;
            width: -webkit-fill-available;
        }
        .ticket-options{
            position: absolute;
            right: 10px;
            top: 10px;
        }
        .v-card__actions{
            margin-right: 23px;
        }
        .cards-slider{
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="vue-main">
        <v-app>
            <v-container>
                <center>
                    <h1>Housie Board</h1><br>
                    <div>
                        <v-btn color="primary" @click="pickANumber()">Generate Number</v-btn>
                        <v-btn color="primary" @click="generateTicket(null)">Generate Ticket</v-btn>
                        <v-btn color="primary" @click="resetColors()">Reset Board</v-btn>
                    </div><br>
                    <div>
                        <span :id="'prev-'+index" v-for="(num,index) in previousNumbers" :class="index == (previousNumbers.length-1)? 'highlight-picked-num' : ''">
                            {{num}}
                        </span>
                    </div>
                    <v-simple-table>
                        <template>
                            <tr v-for="i in numberSequence">
                                <td :id="j" class="cell pa-3 text-center" :class="'cell-'+j" v-for="j in i">
                                    <span>{{j}}</span>
                                </td>
                            </tr>
                        </template>
                    </v-simple-table><br>
                    <v-dialog v-model="showTicket" persistent width="500" height="500">
                        <v-card class="pa-3">
                            <v-card-title>How many tickets you need?</v-card-title><br>
                            <v-card-text>
                                <v-slider v-model="slider"thumb-label="always"
                                    min="1" max="20" class="cards-slider" hide-details
                                ></v-slider>
                            </v-card-text>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn color="success" @click="createTickets(slider)">Generate</v-btn>
                                <v-btn color="error" @click="showTicket = false;">Cancel</v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>
                </center>
            </v-container>
            <v-container fluid>
                <v-card class="pa-3 usedTickets-card" color="indigo lighten-4" v-if="usedTickets.length > 0" >
                    <span class="title">Selected Tickets({{usedTickets.length}})</span>
                    <div class="float-right">
                        <v-icon title="Edit Tickets" v-if="!editTickets" @click="editTickets = !editTickets">create</v-icon><v-icon v-else @click="editTickets = !editTickets">clear</v-icon>
                        <v-icon title="Add Ticket" @click="generateTicket(null)">add</v-icon>
                        <v-icon title="Update All" @click="regenerateTickets('All',-1)">loop</v-icon>
                        <v-icon title="Show Tickets" @click="expanded = !expanded">{{!expanded ? 'keyboard_arrow_down' : 'keyboard_arrow_up'}}</v-icon>
                    </div>
                    <div v-show="expanded">
                        <v-row dense>
                            <v-col cols="6" class="pa-4" v-for="(ticket,index) in usedTickets">
                                <v-flex xs12>
                                    <v-card class="pa-3 usedTickets-inside-card">
                                        <v-layout>
                                            <span v-show="!ticket.updateTicketHolder" class="font-weight-black title align-self-end">{{ticket.name}}</span>
                                            <div v-show="editTickets">
                                                <div v-if="ticket.updateTicketHolder" class="d-inline-flex">
                                                    <v-text-field class="mt-0 pt-0" autofocus placeholder="Name" v-model="updatedTicketName"></v-text-field>
                                                    <v-btn icon><v-icon title="Save" color="success" @click="updateTicketHolderName(index)">done</v-icon></v-btn>
                                                    <v-btn icon><v-icon title="cancel" color="error" @click="ticket.updateTicketHolder = false">clear</v-icon></v-btn>
                                                </div>
                                                <div v-show="!ticket.updateTicketHolder" class="ticket-options">
                                                    <v-icon title="Edit Ticket Holder" @click="ticket.updateTicketHolder = true;updatedTicketName = ticket.name;">create</v-icon>
                                                    <v-icon title="Regenerate Ticket" @click="regenerateTickets('selfTicket',index)">loop</v-icon>
                                                    <v-icon title="Delete Ticket" @click="deleteTicket(index)">delete</v-icon>
                                                </div>
                                            </div>
                                        </v-layout>
                                        <v-flex xs12 overflow-hidden>
                                            <v-simple-table class="table-overflow">
                                                <template>
                                                    <tr v-for="i in ticket.ticket">
                                                        <td v-for="j in i">
                                                            <span v-if="j!=-1">
                                                                {{j}}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </v-simple-table>
                                        </v-flex>
                                    </v-card>
                                </v-flex>
                            </v-col>
                        </v-row>
                    </div>
                </v-card>
            </v-container>
            <p class="text-center">Created by - <span class="font-italic font-weight-black">ARJUN MAMIDI</span></p>
        </v-app>
    </div>
    <script>
        var vm = new Vue({
            el: '#vue-main',
            vuetify: new Vuetify(),
            created() {
                let num = 0;
                let internalArray = [];
                for(var i=0;i<9;i++){
                    for(var j=0;j<10;j++){
                        num++;
                        internalArray.push(num);                        
                    }
                    this.numberSequence[i] = internalArray;
                    internalArray = [];
                }
                this.numbersArray = this.createNumbersArray(1, 90);
                this.getValuesFromLocalStorage();
            },
            watch: {
                previousNumbers(){
                    localStorage.setItem('previousNumbers', JSON.stringify(this.previousNumbers));
                },
                numbersArray(){
                    localStorage.setItem('numbersArray', JSON.stringify(this.numbersArray));
                },
                usedTickets(){
                    localStorage.setItem('usedTickets', JSON.stringify(this.usedTickets));
                }
            },
            mounted(){
                window.addEventListener('beforeunload', (event) => {
                // Cancel the event as stated by the standard.
                event.preventDefault();
                // Chrome requires returnValue to be set.
                event.returnValue = 'sure?';
                });
            },
            data() {
                return {
                    number: 0,
                    numberSequence: [],
                    numbersArray: [],
                    previousNumbers: [],
                    showTicket: false,
                    ticket: [],
                    usedTickets: [],
                    expanded: false,
                    editTickets: false,
                    updatedTicketName: null,
                    slider: 1,
                }
            },
            methods: {
                getRandomNumber(min, max){
                    let step1 = max-min+1;
                    let step2 = Math.random()*step1;
                    let result = Math.floor(step2)+min;
                    return result;
                },
                createNumbersArray(start, end){
                    let arr = [];
                    for(let i = start; i <= end; i++){
                        arr.push(i);
                    }
                    return arr;
                },
                pickANumber(){
                    var self = this;
                    if(self.numbersArray.length){
                        let index = this.getRandomNumber(0,self.numbersArray.length-1);
                        let randomNumber = self.numbersArray[index];
                        self.numbersArray.splice(index, 1);
                        self.previousNumbers.push(randomNumber);
                        document.getElementById(randomNumber).style.background = 'rgba(202, 184, 250, 0.59)';
                    } else{
                       window.alert('Game Completed!!!!!!');
                    }
                },
                generateTicket(action){
                    var self = this;
                    if(action == null){
                        self.showTicket = true;
                    }
                    self.ticket = [
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1],
                        [-1,-1,-1,-1,-1,-1,-1,-1,-1]
                    ];
                    let indexMatrix = self.getIndexMatrix();
                    for(let i = 0;i < 9;i++){
                        let col = [],colIndexArray = [];
                        for(let j = 0;j < 3;j++){
                            let indexArray = indexMatrix[j];
                            if(indexArray.indexOf(i) > -1){
                                let max = (i + 1) * 10, min = i * 10;
                                if(min == 0){ min = 1};
                                let randomNumber = Math.floor(Math.random() * (max - min)) + min;
                                if(col.indexOf(randomNumber) < 0){
                                    col.push(randomNumber);
                                } else {
                                    while(col.indexOf(randomNumber) > -1){
                                        randomNumber = Math.floor(Math.random() * (max - min)) + min;
                                    }
                                    col.push(randomNumber);
                                }
                                colIndexArray.push(j);
                            }
                        }
                        col.sort();
                        let colIndex = 0;
                        colIndexArray.forEach( (index) => {
                            if(index > -1){
                                self.ticket[index][i] = col[colIndex];
                                colIndex++;
                            }
                        });
                    }
                },
                getIndexMatrix(){
                    const self = this;
                    let indexMatrix = [];
                    for(let i = 0;i < 3;i++){
                        let indexArray = [];
                        if(i === 1){
                            const numberSequence = [0,1,2,3,4,5,6,7,8];
                            for(let j = 0; j < 5; j++){
                                numberSequence.splice(numberSequence.indexOf(indexMatrix[0][j]), 1);
                            }
                            indexArray.push(...numberSequence);
                        }
                        while(indexArray.length < 5){
                            const randomNumber = Math.floor(Math.random() * 9);
                            if(indexArray.indexOf(randomNumber) < 0){
                                indexArray.push(randomNumber);
                                indexArray.sort();
                                indexArray = self.checkIsThreeSequence(indexArray);
                            }  
                        }
                        indexMatrix[i] = indexArray.sort();
                    }
                    return indexMatrix;
                },
                checkIsThreeSequence(indexArray){
                    if(indexArray.length > 2){
                        for(let i = 0;i < indexArray.length - 2;i++){
                            if(indexArray[i] == indexArray[i + 1] - 1 && indexArray[i + 1] == indexArray[i + 2] - 1){
                                indexArray.splice((i+2), 1);
                                return indexArray;
                            }
                        }
                        return indexArray;
                    } else {
                        return indexArray;
                    }
                },
                deleteTicket(ticketIndex){
                    var self = this;
                    const ask = confirm('Are you sure?');
                    if(ask){
                        self.usedTickets.splice(ticketIndex, 1);
                    }
                },
                regenerateTickets(desc, index){
                    var self = this;
                    if(desc == 'All'){
                        self.usedTickets.forEach( (ticket) => {
                            self.generateTicket('noPopup');
                            ticket.ticket = self.ticket;
                        })
                    } else if(desc == 'selfTicket'){
                        self.generateTicket('noPopup');
                        self.usedTickets[index].ticket = self.ticket;
                    }
                },
                updateTicketHolderName(index){
                    var self = this;
                    self.usedTickets[index].name = self.updatedTicketName;
                    self.usedTickets[index].updateTicketHolder = false;
                    self.updatedTicketName = null;
                },
                createTickets(count){
                    var self = this;
                    self.expanded = true;
                    window.scrollTo(0,document.querySelector('#vue-main').scrollHeight);
                    const length = self.usedTickets.length;
                    for(let i=length;i<(count+length);i++){
                        self.generateTicket('noPopup');
                        self.useTicket(('User-'+(i+1)));
                    }
                    self.showTicket = false;
                    self.slider = 1;
                },
                useTicket(ticketHolder){
                    var self = this;
                    const ticketObj = {
                        name: ticketHolder,
                        ticket: self.ticket,
                        updateTicketHolder: false,
                    }
                    self.usedTickets.push(ticketObj);
                },
                getValuesFromLocalStorage(){
                    var self = this;
                    if(JSON.parse(localStorage.getItem('previousNumbers')) != null && JSON.parse(localStorage.getItem('numbersArray')) != null){
                        self.previousNumbers = JSON.parse(localStorage.getItem('previousNumbers'));
                        self.numbersArray = JSON.parse(localStorage.getItem('numbersArray'));
                        // self.addColors();
                    }
                    if(JSON.parse(localStorage.getItem('usedTickets'))){
                        self.usedTickets = JSON.parse(localStorage.getItem('usedTickets'));
                    }
                },
                addColors(){
                    var self = this;
                    self.previousNumbers.forEach( (num) => {
                        let ele = 'cell-'+num;
                        console.log(ele);
                        const elem = document.getElementsByClassName(ele);
                        console.log(elem);
                        document.getElementById(num).style.background = 'rgba(202, 184, 250, 0.59)';
                    });
                },
                resetColors(){
                    const ask = confirm('Are you sure?');
                    if(ask){
                        const list = document.querySelectorAll('.cell');
                        list.forEach((element) => {
                            element.style.background = 'white';
                        });
                        this.numbersArray = this.createNumbersArray(1, 90);
                        this.previousNumbers = [];
                    }
                },
            }
        })
    </script>
</body>
</html>
